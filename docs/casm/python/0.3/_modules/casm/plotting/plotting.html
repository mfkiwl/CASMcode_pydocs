

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>casm.plotting.plotting &mdash; CASM 0.3.dev documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> CASM
          

          
          </a>

          
            
            
              <div class="version">
                0.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../python/index.html">CASM Python packages documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about.html">About CASM</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CASM</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>casm.plotting.plotting</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for casm.plotting.plotting</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="o">*</span>

<span class="c1"># conda&#39;s current version of pandas raises these warnings, but they are safe</span>
<span class="c1"># see: https://stackoverflow.com/questions/40845304</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;numpy.dtype size changed&quot;</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;numpy.ufunc size changed&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">import</span> <span class="nn">bokeh.client</span>
<span class="kn">import</span> <span class="nn">bokeh.io</span>
<span class="kn">import</span> <span class="nn">bokeh.models</span>
<span class="kn">import</span> <span class="nn">bokeh.plotting</span>
<span class="kn">import</span> <span class="nn">bokeh.layouts</span> <span class="k">as</span> <span class="nn">bk_layouts</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">import</span> <span class="nn">casm</span>
<span class="kn">import</span> <span class="nn">casm.project</span>
<span class="kn">import</span> <span class="nn">casm.learn</span>
<span class="kn">from</span> <span class="nn">casm.misc</span> <span class="k">import</span> <span class="n">compat</span>

<span class="n">int_dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;int16&#39;</span><span class="p">,</span> <span class="s1">&#39;int32&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;float16&#39;</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">]</span>
<span class="n">float_dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;int16&#39;</span><span class="p">,</span> <span class="s1">&#39;int32&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;float16&#39;</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">]</span>
<span class="n">numerics</span> <span class="o">=</span> <span class="n">int_dtypes</span> <span class="o">+</span> <span class="n">float_dtypes</span>

<span class="k">class</span> <span class="nc">Session</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">doc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">doc</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">curdoc</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">doc</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">push_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">add_root</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layout</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">add_root</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">begin_interactive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">loop_until_closed</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Messages</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;TextInput for writing messages&quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">TextInput</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Messages:&quot;</span><span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

  <span class="nd">@value</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_value</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_selected</span><span class="p">(</span><span class="n">sel</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Selected configurations&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="s1">&#39;to_be_selected&#39;</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;to_be_selected&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span>

<span class="k">def</span> <span class="nf">_unselected</span><span class="p">(</span><span class="n">sel</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Unselected configurations&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="s1">&#39;to_be_selected&#39;</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;to_be_selected&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span>


<span class="k">def</span> <span class="nf">hull_dist</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;CALCULATED&quot;</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Equivalent to &#39;hull_dist(&#39; + path + &#39;,comp)&#39;</span>

<span class="sd">  Arguments:</span>
<span class="sd">    path: a CASM Selection path, default &quot;CALCULATED&quot;</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="s1">&#39;hull_dist(&#39;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;,comp)&#39;</span>

<span class="k">def</span> <span class="nf">hull_dist_per_atom</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;CALCULATED&quot;</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Equivalent to &#39;hull_dist(&#39; + path + &#39;,atom_frac)&#39;</span>

<span class="sd">  Arguments:</span>
<span class="sd">    path: a CASM Selection path, default &quot;CALCULATED&quot;</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="s1">&#39;hull_dist(&#39;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;,atom_frac)&#39;</span>

<span class="k">def</span> <span class="nf">clex_hull_dist</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;CALCULATED&quot;</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Equivalent to &#39;clex_hull_dist(&#39; + path + &#39;,comp)&#39;</span>

<span class="sd">  Arguments:</span>
<span class="sd">    path: a CASM Selection path, default &quot;CALCULATED&quot;</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="s1">&#39;clex_&#39;</span> <span class="o">+</span> <span class="n">hull_dist</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">clex_hull_dist_per_atom</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;CALCULATED&quot;</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Equivalent to &#39;hull_dist(&#39; + path + &#39;,atom_frac)&#39;</span>

<span class="sd">  Arguments:</span>
<span class="sd">    path: a CASM Selection path, default &quot;CALCULATED&quot;</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="s1">&#39;clex_&#39;</span> <span class="o">+</span> <span class="n">hull_dist_per_atom</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">set_src_data</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Add/modify data column in a ColumnDataSource, creating the column if necessary&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">column_names</span><span class="p">:</span>
    <span class="n">src</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">force</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">src</span><span class="o">.</span><span class="n">patch</span><span class="p">({</span><span class="n">name</span><span class="p">:(</span><span class="nb">slice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span><span class="n">data</span><span class="p">)})</span>

<div class="viewcode-block" id="add_src_data"><a class="viewcode-back" href="../../../python/casm.plotting.add_src_data.html#casm.plotting.add_src_data">[docs]</a><span class="k">def</span> <span class="nf">add_src_data</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Add data to Selection&#39;s ColumnDataSource, creating if necessary&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">src</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">sel</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">data</span><span class="p">})</span>
    <span class="n">sel</span><span class="o">.</span><span class="n">selection_callbacks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">callbacks</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">selection_callbacks</span><span class="p">:</span>
        <span class="n">f</span><span class="p">()</span>
    <span class="n">sel</span><span class="o">.</span><span class="n">update_selection</span> <span class="o">=</span> <span class="n">callbacks</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">set_src_data</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span></div>

<div class="viewcode-block" id="view_on_tap"><a class="viewcode-back" href="../../../python/casm.plotting.view_on_tap.html#casm.plotting.view_on_tap">[docs]</a><span class="k">def</span> <span class="nf">view_on_tap</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Execute &#39;casm view&#39; on tapped configuration</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">selected</span><span class="p">[</span><span class="s1">&#39;1d&#39;</span><span class="p">][</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">selected</span><span class="p">[</span><span class="s1">&#39;1d&#39;</span><span class="p">][</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">configname</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;configname&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
    <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;view &quot;</span> <span class="o">+</span> <span class="n">configname</span>
    <span class="n">sel</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="PlottingData"><a class="viewcode-back" href="../../../python/casm.plotting.PlottingData.html#casm.plotting.PlottingData">[docs]</a><span class="k">class</span> <span class="nc">PlottingData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="PlottingData.__init__"><a class="viewcode-back" href="../../../python/casm.plotting.PlottingData.html#casm.plotting.PlottingData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tap_action</span> <span class="o">=</span> <span class="n">TapAction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">add_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">proj</span> <span class="ow">in</span> <span class="n">proj_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">proj</span><span class="o">.</span><span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_</span><span class="p">[</span><span class="n">proj</span><span class="o">.</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;project&#39;</span><span class="p">:</span><span class="n">proj</span><span class="p">,</span> <span class="s1">&#39;selections&#39;</span><span class="p">:{}}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_</span><span class="p">[</span><span class="n">proj</span><span class="o">.</span><span class="n">path</span><span class="p">][</span><span class="s1">&#39;project&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj</span>

    <span class="k">def</span> <span class="nf">add_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sel</span> <span class="ow">in</span> <span class="n">sel_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_</span><span class="p">[</span><span class="n">sel</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;project&#39;</span><span class="p">:</span><span class="n">sel</span><span class="o">.</span><span class="n">proj</span><span class="p">,</span> <span class="s1">&#39;selections&#39;</span><span class="p">:{</span><span class="n">sel</span><span class="o">.</span><span class="n">path</span><span class="p">:</span><span class="n">sel</span><span class="p">}}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_</span><span class="p">[</span><span class="n">sel</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">path</span><span class="p">][</span><span class="s1">&#39;selections&#39;</span><span class="p">][</span><span class="n">sel</span><span class="o">.</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">sel</span>

    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">proj_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">proj_path</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">project_path</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proj_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">proj_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proj_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">Project</span><span class="p">(</span><span class="n">proj_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_project</span><span class="p">([</span><span class="n">proj</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_</span><span class="p">[</span><span class="n">proj_path</span><span class="p">][</span><span class="s1">&#39;project&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sel_path</span><span class="o">=</span><span class="s2">&quot;MASTER&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">proj_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">()):</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">proj_path</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">proj_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sel_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sel_path</span> <span class="o">=</span> <span class="s2">&quot;MASTER&quot;</span>
        <span class="k">if</span> <span class="n">sel_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;MASTER&quot;</span><span class="p">,</span> <span class="s2">&quot;ALL&quot;</span><span class="p">,</span> <span class="s2">&quot;CALCULATED&quot;</span><span class="p">]:</span>
            <span class="n">sel_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sel_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sel_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_</span><span class="p">[</span><span class="n">proj</span><span class="o">.</span><span class="n">path</span><span class="p">][</span><span class="s1">&#39;selections&#39;</span><span class="p">]:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">proj</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="n">sel_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_selection</span><span class="p">([</span><span class="n">sel</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_</span><span class="p">[</span><span class="n">proj</span><span class="o">.</span><span class="n">path</span><span class="p">][</span><span class="s1">&#39;selections&#39;</span><span class="p">][</span><span class="n">sel_path</span><span class="p">]</span></div>





<div class="viewcode-block" id="TapAction"><a class="viewcode-back" href="../../../python/casm.plotting.TapAction.html#casm.plotting.TapAction">[docs]</a><span class="k">class</span> <span class="nc">TapAction</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Enable execution of a python function when a glyph is &#39;tapped&#39; in a bokeh plot.</span>

<span class="sd">  Example:</span>
<span class="sd">    p = ... a Bokeh plot</span>
<span class="sd">    circles = p.circ(... A set of circles)</span>
<span class="sd">    my_tap_action = TapAction(sel)</span>
<span class="sd">    def f(sel, attrname, old, new):</span>
<span class="sd">      if len(sel.src.selected[&#39;1d&#39;][&#39;indices&#39;]) == 1:</span>
<span class="sd">        # the index of the tapped configuration:</span>
<span class="sd">        index = sel.src.selected[&#39;1d&#39;][&#39;indices&#39;][0]</span>
<span class="sd">        ... code to execute ...</span>
<span class="sd">        ... basically can ignore attrname, old, new ...</span>

<span class="sd">    # call f when a circle is tapped</span>
<span class="sd">    p.add_tools(my_tap_action.tool(f, [circles]))</span>

<span class="sd">  Attributes:</span>

<span class="sd">      data: PlottingData instance</span>
<span class="sd">          Use to store associated Project and Selection</span>

<span class="sd">      py_callback: {&lt;sel_name&gt;:&lt;Python function&gt;}</span>
<span class="sd">          Dict of callback functions with signature: f(Selection, attrname, old, new).</span>
<span class="sd">          Set the callback function using the &#39;tool&#39; method. See &#39;view_on_tap&#39;</span>
<span class="sd">          for an example.</span>

<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TapAction.__init__"><a class="viewcode-back" href="../../../python/casm.plotting.TapAction.html#casm.plotting.TapAction.__init__">[docs]</a>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments:</span>

<span class="sd">        data: PlottingData instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tap_indicator_src</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;project&quot;</span><span class="p">:[</span><span class="s1">&#39;None&#39;</span><span class="p">],</span> <span class="s2">&quot;selection&quot;</span><span class="p">:[</span><span class="s1">&#39;None&#39;</span><span class="p">]})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">js_callback</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">CustomJS</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;src&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">tap_indicator_src</span><span class="p">},</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      var data = src.data;</span>
<span class="s2">      data[&#39;x&#39;][0] = data[&#39;x&#39;][0] + 1;</span>
<span class="s2">      hovered_data = cb_data.source.data;</span>
<span class="s2">      data[&#39;project&#39;][0] = hovered_data[&#39;project&#39;][0];</span>
<span class="s2">      data[&#39;selection&#39;][0] = hovered_data[&#39;selection&#39;][0];</span>
<span class="s2">      src.data = data;</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">py_callback</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">renderers</span> <span class="o">=</span> <span class="p">[]</span></div>

  <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
    <span class="n">proj_path</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sel_path</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">selection</span><span class="p">(</span><span class="n">proj_path</span><span class="p">,</span> <span class="n">sel_path</span><span class="p">,</span> <span class="n">proj_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;verbose&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">py_callback</span><span class="p">[</span><span class="n">sel_path</span><span class="p">](</span><span class="n">sel</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">renderers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">py_callback</span><span class="p">[</span><span class="n">sel</span><span class="o">.</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">renderers</span> <span class="o">+=</span> <span class="n">renderers</span>

  <span class="k">def</span> <span class="nf">tool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tap_indicator_src</span><span class="o">.</span><span class="n">on_change</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">TapTool</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">js_callback</span><span class="p">,</span> <span class="n">renderers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">renderers</span><span class="p">)</span></div>


<span class="c1"># convex hull plot</span>

<span class="n">default_dft_hull_style</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="s2">&quot;circle&quot;</span><span class="p">,</span>
  <span class="s2">&quot;hover_color&quot;</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span>
  <span class="s2">&quot;hover_alpha&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
  <span class="s2">&quot;fill_alpha&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
  <span class="s2">&quot;selected&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="s2">&quot;radii&quot;</span><span class="p">:</span> <span class="mi">10</span>
  <span class="p">},</span>
  <span class="s2">&quot;unselected&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span>
    <span class="s2">&quot;radii&quot;</span><span class="p">:</span> <span class="mi">7</span>
  <span class="p">},</span>
  <span class="s2">&quot;on_hull&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;line_color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="s2">&quot;line_width&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="s2">&quot;line_alpha&quot;</span><span class="p">:</span> <span class="mf">0.8</span>
  <span class="p">},</span>
  <span class="s2">&quot;off_hull&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;line_color&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
    <span class="s2">&quot;line_width&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="s2">&quot;line_alpha&quot;</span><span class="p">:</span> <span class="mf">0.0</span>
  <span class="p">},</span>
  <span class="s2">&quot;hull_line_width&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
  <span class="s2">&quot;hull_line_dash&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="p">}</span>

<span class="n">default_clex_hull_style</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
  <span class="s2">&quot;hover_color&quot;</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span>
  <span class="s2">&quot;hover_alpha&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
  <span class="s2">&quot;fill_alpha&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
  <span class="s2">&quot;selected&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
    <span class="s2">&quot;radii&quot;</span><span class="p">:</span> <span class="mi">10</span>
  <span class="p">},</span>
  <span class="s2">&quot;unselected&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span>
    <span class="s2">&quot;radii&quot;</span><span class="p">:</span> <span class="mi">7</span>
  <span class="p">},</span>
  <span class="s2">&quot;on_hull&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;line_color&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
    <span class="s2">&quot;line_width&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="s2">&quot;line_alpha&quot;</span><span class="p">:</span> <span class="mf">0.8</span>
  <span class="p">},</span>
  <span class="s2">&quot;off_hull&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;line_color&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
    <span class="s2">&quot;line_width&quot;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
    <span class="s2">&quot;line_alpha&quot;</span><span class="p">:</span> <span class="mf">0.5</span>
  <span class="p">},</span>
  <span class="s2">&quot;hull_line_width&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
  <span class="s2">&quot;hull_line_dash&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="s2">&quot;clex_of_dft_hull_line_dash&quot;</span><span class="p">:</span> <span class="s2">&quot;4 4&quot;</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">_hull_style</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="s1">&#39;hover_color&#39;</span><span class="p">,</span> <span class="s1">&#39;hover_alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;selected&#39;</span><span class="p">,</span>
        <span class="s1">&#39;hull_line_width&#39;</span><span class="p">,</span> <span class="s1">&#39;hull_line_dash&#39;</span><span class="p">,</span> <span class="s1">&#39;fill_alpha&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clex_of_dft_hull_line_dash&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">default</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
            <span class="nb">input</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">,</span> <span class="s1">&#39;unselected&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tmp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
            <span class="nb">input</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;radii&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">[</span><span class="n">tmp</span><span class="p">]:</span>
                <span class="nb">input</span><span class="p">[</span><span class="n">tmp</span><span class="p">][</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span><span class="p">[</span><span class="n">tmp</span><span class="p">][</span><span class="n">val</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;on_hull&#39;</span><span class="p">,</span> <span class="s1">&#39;off_hull&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tmp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
            <span class="nb">input</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;line_color&#39;</span><span class="p">,</span> <span class="s1">&#39;line_width&#39;</span><span class="p">,</span> <span class="s1">&#39;line_alpha&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">[</span><span class="n">tmp</span><span class="p">]:</span>
                <span class="nb">input</span><span class="p">[</span><span class="n">tmp</span><span class="p">][</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span><span class="p">[</span><span class="n">tmp</span><span class="p">][</span><span class="n">val</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">input</span>

<div class="viewcode-block" id="dft_hull_style"><a class="viewcode-back" href="../../../python/casm.plotting.dft_hull_style.html#casm.plotting.dft_hull_style">[docs]</a><span class="k">def</span> <span class="nf">dft_hull_style</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_hull_style</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">default_dft_hull_style</span><span class="p">)</span></div>

<div class="viewcode-block" id="clex_hull_style"><a class="viewcode-back" href="../../../python/casm.plotting.clex_hull_style.html#casm.plotting.clex_hull_style">[docs]</a><span class="k">def</span> <span class="nf">clex_hull_style</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_hull_style</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">default_clex_hull_style</span><span class="p">)</span></div>


<span class="n">rank_select_cutoff_style</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
  <span class="s2">&quot;line_width&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="p">}</span>

<span class="n">default_scatter_style</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="s2">&quot;circle&quot;</span><span class="p">,</span>
  <span class="s2">&quot;hover_color&quot;</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span>
  <span class="s2">&quot;hover_alpha&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
  <span class="s2">&quot;selected&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
    <span class="s2">&quot;radii&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;line_color&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
    <span class="s2">&quot;line_width&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="s2">&quot;line_alpha&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="s2">&quot;fill_alpha&quot;</span><span class="p">:</span> <span class="mf">0.5</span>
  <span class="p">},</span>
  <span class="s2">&quot;unselected&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
    <span class="s2">&quot;radii&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s2">&quot;line_color&quot;</span><span class="p">:</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span>
    <span class="s2">&quot;line_width&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="s2">&quot;line_alpha&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="s2">&quot;fill_alpha&quot;</span><span class="p">:</span> <span class="mf">0.3</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">default_figure_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;plot_height&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
    <span class="s2">&quot;plot_width&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
    <span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="s2">&quot;crosshair,pan,reset,box_zoom,wheel_zoom,save&quot;</span>
<span class="p">}</span>


<div class="viewcode-block" id="scatter_series_style"><a class="viewcode-back" href="../../../python/casm.plotting.scatter_series_style.html#casm.plotting.scatter_series_style">[docs]</a><span class="k">def</span> <span class="nf">scatter_series_style</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
  <span class="n">selected_color</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;cyan&quot;</span><span class="p">,</span> <span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">]</span>
  <span class="n">unselected_color</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">]</span>
  <span class="n">marker</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;circle&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="s2">&quot;square&quot;</span><span class="p">,</span> <span class="s2">&quot;diamond&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;cross&quot;</span><span class="p">]</span>

  <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hover_color&#39;</span><span class="p">,</span> <span class="s1">&#39;hover_alpha&#39;</span><span class="p">]:</span>
      <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
          <span class="nb">input</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_scatter_style</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>

  <span class="k">if</span> <span class="s1">&#39;marker&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
      <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;marker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">marker</span><span class="p">[</span><span class="n">index</span> <span class="o">%</span> <span class="mi">6</span><span class="p">]</span>

  <span class="k">if</span> <span class="s1">&#39;selected&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
      <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">default_scatter_style</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">])</span>
      <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_color</span><span class="p">[</span><span class="n">index</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]</span>
      <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">][</span><span class="s1">&#39;line_color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_color</span><span class="p">[</span><span class="n">index</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;radii&#39;</span><span class="p">,</span> <span class="s1">&#39;line_width&#39;</span><span class="p">,</span> <span class="s1">&#39;line_alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;fill_alpha&#39;</span><span class="p">]:</span>
          <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]:</span>
              <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_scatter_style</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
      <span class="k">if</span> <span class="s1">&#39;color&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]:</span>
          <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_color</span><span class="p">[</span><span class="n">index</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]</span>
      <span class="k">if</span> <span class="s1">&#39;line_color&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]:</span>
          <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">][</span><span class="s1">&#39;line_color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_color</span><span class="p">[</span><span class="n">index</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]</span>

  <span class="k">if</span> <span class="s1">&#39;unselected&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
      <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">default_scatter_style</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">])</span>
      <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unselected_color</span><span class="p">[</span><span class="n">index</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]</span>
      <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">][</span><span class="s1">&#39;line_color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unselected_color</span><span class="p">[</span><span class="n">index</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;radii&#39;</span><span class="p">,</span> <span class="s1">&#39;line_width&#39;</span><span class="p">,</span> <span class="s1">&#39;line_alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;fill_alpha&#39;</span><span class="p">]:</span>
          <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">]:</span>
              <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_scatter_style</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
      <span class="k">if</span> <span class="s1">&#39;color&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">]:</span>
          <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unselected_color</span><span class="p">[</span><span class="n">index</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]</span>
      <span class="k">if</span> <span class="s1">&#39;line_color&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">]:</span>
          <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">][</span><span class="s1">&#39;line_color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unselected_color</span><span class="p">[</span><span class="n">index</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]</span>

  <span class="k">return</span> <span class="nb">input</span></div>

<div class="viewcode-block" id="rankplot_style"><a class="viewcode-back" href="../../../python/casm.plotting.rankplot_style.html#casm.plotting.rankplot_style">[docs]</a><span class="k">def</span> <span class="nf">rankplot_style</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="s1">&#39;selected&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
      <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;line_width&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]:</span>
      <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">][</span><span class="s1">&#39;line_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="s1">&#39;line_alpha&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]:</span>
      <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">][</span><span class="s1">&#39;line_alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">if</span> <span class="s1">&#39;unselected&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
      <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;line_width&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">]:</span>
      <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">][</span><span class="s1">&#39;line_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="s1">&#39;line_alpha&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]:</span>
      <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">][</span><span class="s1">&#39;line_alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">return</span> <span class="n">scatter_series_style</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_dft_hull_glyphs"><a class="viewcode-back" href="../../../python/casm.plotting.update_dft_hull_glyphs.html#casm.plotting.update_dft_hull_glyphs">[docs]</a><span class="k">def</span> <span class="nf">update_dft_hull_glyphs</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">selected</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Use the selected and on_hull iterables to update glyph styles based on sel.dft_style.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">selected</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span>

  <span class="c1">## clex points:</span>

  <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;radii&#39;</span><span class="p">]:</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="kc">True</span><span class="p">:</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">],</span> <span class="kc">False</span><span class="p">:</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">]})</span>
    <span class="n">set_src_data</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cmap</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">selected</span><span class="p">)),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="n">on_dft_hull</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="k">if</span> <span class="s1">&#39;on_dft_hull&#39;</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">on_dft_hull</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;on_dft_hull&#39;</span><span class="p">]</span>

  <span class="k">if</span> <span class="n">on_dft_hull</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;line_color&#39;</span><span class="p">,</span> <span class="s1">&#39;line_width&#39;</span><span class="p">,</span> <span class="s1">&#39;line_alpha&#39;</span><span class="p">]:</span>
      <span class="n">cmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="kc">True</span><span class="p">:</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;on_hull&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">],</span> <span class="kc">False</span><span class="p">:</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;off_hull&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">]})</span>
      <span class="n">set_src_data</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cmap</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">on_dft_hull</span><span class="p">)),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_clex_hull_glyphs"><a class="viewcode-back" href="../../../python/casm.plotting.update_clex_hull_glyphs.html#casm.plotting.update_clex_hull_glyphs">[docs]</a><span class="k">def</span> <span class="nf">update_clex_hull_glyphs</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">selected</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Use the selected and on_hull iterables to update glyph styles based on sel.clex_style.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="n">selected</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span>

  <span class="c1">## clex points:</span>

  <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;radii&#39;</span><span class="p">]:</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="kc">True</span><span class="p">:</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">],</span> <span class="kc">False</span><span class="p">:</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">]})</span>
    <span class="n">set_src_data</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;clex_&#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cmap</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">selected</span><span class="p">)),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="n">on_clex_hull</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="k">if</span> <span class="s1">&#39;on_clex_hull&#39;</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">on_clex_hull</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;on_clex_hull&#39;</span><span class="p">]</span>

  <span class="k">if</span> <span class="n">on_clex_hull</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;line_color&#39;</span><span class="p">,</span> <span class="s1">&#39;line_width&#39;</span><span class="p">,</span> <span class="s1">&#39;line_alpha&#39;</span><span class="p">]:</span>
      <span class="n">cmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="kc">True</span><span class="p">:</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;on_hull&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">],</span> <span class="kc">False</span><span class="p">:</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;off_hull&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">]})</span>
      <span class="n">set_src_data</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;clex_&#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cmap</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">on_clex_hull</span><span class="p">)),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_scatter_glyphs"><a class="viewcode-back" href="../../../python/casm.plotting.update_scatter_glyphs.html#casm.plotting.update_scatter_glyphs">[docs]</a><span class="k">def</span> <span class="nf">update_scatter_glyphs</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">selected</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

  <span class="k">if</span> <span class="n">selected</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span>

  <span class="c1">## clex points:</span>

  <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;radii&#39;</span><span class="p">,</span> <span class="s1">&#39;line_color&#39;</span><span class="p">,</span> <span class="s1">&#39;line_width&#39;</span><span class="p">,</span> <span class="s1">&#39;line_alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;fill_alpha&#39;</span><span class="p">]:</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="kc">True</span><span class="p">:</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">],</span> <span class="kc">False</span><span class="p">:</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;unselected&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">]})</span>
    <span class="n">set_src_data</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">id</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cmap</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">selected</span><span class="p">)),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="ConvexHullPlot"><a class="viewcode-back" href="../../../python/casm.plotting.ConvexHullPlot.html#casm.plotting.ConvexHullPlot">[docs]</a><span class="k">class</span> <span class="nc">ConvexHullPlot</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Attributes:</span>
<span class="sd">      data</span>
<span class="sd">      sel</span>
<span class="sd">      hull_sel</span>
<span class="sd">      hull_sel_calculated</span>
<span class="sd">      dft_hull_sel</span>
<span class="sd">      is_comp, is_comp_n, is_atom_frac</span>
<span class="sd">      x, x_all, y, y_clex</span>
<span class="sd">      hull_tol</span>
<span class="sd">      dft_style, clex_style</span>
<span class="sd">      tooltips, tooltips_exclude</span>
<span class="sd">      r_dft, r_dft_hull_line</span>
<span class="sd">      r_clex, r_clex_hull_line, r_clex_of_dft_hull_line</span>
<span class="sd">      renderers</span>
<span class="sd">      sorted_dft_hull</span>
<span class="sd">      sorted_clex_hull</span>
<span class="sd">      sorted_clex_of_dft_hull</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConvexHullPlot.__init__"><a class="viewcode-back" href="../../../python/casm.plotting.ConvexHullPlot.html#casm.plotting.ConvexHullPlot.__init__">[docs]</a>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="s2">&quot;MASTER&quot;</span><span class="p">,</span> <span class="n">hull_selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;comp(a)&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;formation_energy&#39;</span><span class="p">,</span> <span class="n">tooltips</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">dft_style</span><span class="o">=</span><span class="p">{},</span> <span class="n">clex_style</span><span class="o">=</span><span class="p">{},</span> <span class="n">hull_tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">series_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments:</span>
<span class="sd">      data: PlottingData object</span>
<span class="sd">      project: path to CASM project (optional, default=casm.project.project_path())</span>
<span class="sd">      selection: path for CASM Selection</span>
<span class="sd">      hull_selection: path for CASM Selection to use for the hull. Default uses selection.</span>
<span class="sd">      x: (str) column name to use as x axis. Default=&#39;comp(a)&#39;. Must be &#39;comp(x)&#39;, &#39;comp_n(X)&#39;, or &#39;atom_frac(X)&#39;.</span>
<span class="sd">      y: (str) column name to use as y axis. Default=&#39;formation_energy&#39;. Must be &#39;formation_energy&#39; or &#39;formation_energy_per_atom&#39;.</span>
<span class="sd">      tooltips:</span>
<span class="sd">      dft_style:</span>
<span class="sd">      clex_style:</span>
<span class="sd">      hull_tol: (number, default 1e-8) tolerance to decide if configuration is on the hull</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">PlottingData</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

    <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">project_path</span><span class="p">()</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;verbose&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>

    <span class="n">prim</span> <span class="o">=</span> <span class="n">proj</span><span class="o">.</span><span class="n">prim</span>
    <span class="k">if</span> <span class="n">prim</span><span class="o">.</span><span class="n">n_independent_compositions</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in project:&quot;</span><span class="p">,</span> <span class="n">proj</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;n_independent_compositions:&quot;</span><span class="p">,</span> <span class="n">prim</span><span class="o">.</span><span class="n">n_independent_compositions</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Currently ConvexHullPlot only works for binary alloys&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">selection</span> <span class="o">=</span> <span class="s2">&quot;MASTER&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">selection</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">proj_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;verbose&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">hull_selection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">hull_selection</span> <span class="o">=</span> <span class="n">selection</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hull_sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">selection</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">hull_selection</span><span class="p">,</span> <span class="n">proj_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;verbose&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">hull_sel_calculated</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">proj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hull_sel</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.calculated&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dft_hull_sel</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">proj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hull_sel</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.dft_hull&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">add_selection</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel_calculated</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dft_hull_sel</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">is_comp</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_comp_n</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_atom_frac</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*comp\(.*\)\s*&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">is_comp</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">x_all</span> <span class="o">=</span> <span class="s2">&quot;comp&quot;</span>
    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*comp_n\(.*\)\s*&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">is_comp_n</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">x_all</span> <span class="o">=</span> <span class="s2">&quot;comp_n&quot;</span>
    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*atom_frac\(.*\)\s*&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">is_atom_frac</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">x_all</span> <span class="o">=</span> <span class="s2">&quot;atom_frac&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ConvexHullPlot x: &#39;&quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s2">&quot;&#39; is not allowed.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>

    <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="s1">&#39;formation_energy&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ef_per_atom</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_clex</span> <span class="o">=</span> <span class="s1">&#39;clex(formation_energy)&#39;</span>
    <span class="k">elif</span> <span class="n">y</span> <span class="o">==</span> <span class="s1">&#39;formation_energy_per_atom&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ef_per_atom</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_clex</span> <span class="o">=</span> <span class="s1">&#39;clex(formation_energy,per_species)&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ConvexHullPlot y: &#39;&quot;</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="s2">&quot;&#39; is not allowed.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">hull_tol</span> <span class="o">=</span> <span class="n">hull_tol</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">dft_style</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">dft_hull_style</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dft_style</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">clex_style</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">clex_hull_style</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">clex_style</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span> <span class="o">=</span> <span class="n">tooltips</span></div>


  <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tap_action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="o">**</span><span class="n">default_figure_kwargs</span><span class="p">)</span>

    <span class="n">update_dft_hull_glyphs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dft_style</span><span class="p">)</span>
    <span class="n">update_clex_hull_glyphs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clex_style</span><span class="p">)</span>

    <span class="c1"># plot formation energy vs comp, with convex hull states</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">renderers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># dft</span>
    <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dft_style</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">r_dft</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">style</span><span class="p">[</span><span class="s1">&#39;marker&#39;</span><span class="p">])(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
      <span class="n">size</span><span class="o">=</span><span class="s1">&#39;radii&#39;</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;fill_alpha&#39;</span><span class="p">],</span>
      <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;line_color&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="s1">&#39;line_width&#39;</span><span class="p">,</span> <span class="n">line_alpha</span><span class="o">=</span><span class="s1">&#39;line_alpha&#39;</span><span class="p">,</span>
      <span class="n">hover_alpha</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hover_alpha&#39;</span><span class="p">],</span> <span class="n">hover_color</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hover_color&#39;</span><span class="p">],</span>
      <span class="n">legend</span><span class="o">=</span><span class="s2">&quot;dft&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">r_dft_hull_line</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_hull_src</span><span class="p">,</span>
      <span class="n">line_color</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;on_hull&#39;</span><span class="p">][</span><span class="s1">&#39;line_color&#39;</span><span class="p">],</span> <span class="n">line_width</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hull_line_width&#39;</span><span class="p">],</span>
      <span class="n">line_dash</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hull_line_dash&#39;</span><span class="p">],</span>
      <span class="n">legend</span><span class="o">=</span><span class="s2">&quot;dft&quot;</span><span class="p">)</span>

    <span class="c1"># clex</span>
    <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clex_style</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">r_clex</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">style</span><span class="p">[</span><span class="s1">&#39;marker&#39;</span><span class="p">])(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_clex</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
      <span class="n">size</span><span class="o">=</span><span class="s1">&#39;clex_radii&#39;</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;clex_color&#39;</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;fill_alpha&#39;</span><span class="p">],</span>
      <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;clex_line_color&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="s1">&#39;clex_line_width&#39;</span><span class="p">,</span> <span class="n">line_alpha</span><span class="o">=</span><span class="s1">&#39;clex_line_alpha&#39;</span><span class="p">,</span>
      <span class="n">hover_alpha</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hover_alpha&#39;</span><span class="p">],</span> <span class="n">hover_color</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hover_color&#39;</span><span class="p">],</span>
      <span class="n">legend</span><span class="o">=</span><span class="s2">&quot;clex&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">r_clex_hull_line</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_clex</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clex_hull_src</span><span class="p">,</span>
      <span class="n">line_color</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;on_hull&#39;</span><span class="p">][</span><span class="s1">&#39;line_color&#39;</span><span class="p">],</span> <span class="n">line_width</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hull_line_width&#39;</span><span class="p">],</span>
      <span class="n">line_dash</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hull_line_dash&#39;</span><span class="p">],</span>
      <span class="n">legend</span><span class="o">=</span><span class="s2">&quot;clex&quot;</span><span class="p">)</span>

    <span class="c1"># clex of dft hull</span>
    <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clex_style</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">r_clex_of_dft_hull_line</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_clex</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clex_of_dft_hull_src</span><span class="p">,</span>
      <span class="n">line_color</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;on_hull&#39;</span><span class="p">][</span><span class="s1">&#39;line_color&#39;</span><span class="p">],</span> <span class="n">line_width</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hull_line_width&#39;</span><span class="p">],</span>
      <span class="n">line_dash</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;clex_of_dft_hull_line_dash&#39;</span><span class="p">],</span>
      <span class="n">legend</span><span class="o">=</span><span class="s2">&quot;clex_of_dft_hull&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">renderers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r_dft</span><span class="p">,</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">r_dft_hull_line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_clex</span><span class="p">,</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">r_clex_hull_line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_clex_of_dft_hull_line</span><span class="p">]</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>

    <span class="k">if</span> <span class="n">tap_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tap_action</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="n">view_on_tap</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r_dft</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_clex</span><span class="p">])</span>

    <span class="c1"># hover over a point to see &#39;configname&#39;, &#39;Ef&#39;, and &#39;comp(a)&#39;</span>
    <span class="n">tooltips</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;configname&quot;</span><span class="p">,</span><span class="s2">&quot;@configname&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># tooltips for energy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ef_per_atom</span><span class="p">:</span>
          <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Ef_per_atom&quot;</span><span class="p">,</span><span class="s2">&quot;@formation_energy_per_atom</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
          <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;clex_Ef_per_atom&quot;</span><span class="p">,</span><span class="s2">&quot;@{clex(formation_energy,per_species)}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
          <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;hull_dist_per_atom&quot;</span><span class="p">,</span> <span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="n">hull_dist_per_atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel_calculated</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
          <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;clex_hull_dist_per_atom&quot;</span><span class="p">,</span> <span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="n">clex_hull_dist_per_atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
          <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;clex_of_dft_hull_dist_per_atom&quot;</span><span class="p">,</span> <span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="n">clex_hull_dist_per_atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dft_hull_sel</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Ef&quot;</span><span class="p">,</span><span class="s2">&quot;@formation_energy</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
          <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;clex_Ef&quot;</span><span class="p">,</span><span class="s2">&quot;@{clex(formation_energy)}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
          <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;hull_dist&quot;</span><span class="p">,</span> <span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="n">hull_dist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel_calculated</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
          <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;clex_hull_dist&quot;</span><span class="p">,</span> <span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="n">clex_hull_dist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
          <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;clex_of_dft_hull_dist&quot;</span><span class="p">,</span> <span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="n">clex_hull_dist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dft_hull_sel</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">float_dtypes</span><span class="p">:</span>
                <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span><span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span><span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span><span class="p">))</span>

        <span class="c1"># tooltips for composition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_comp</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*comp\(.*\)\s*&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
              <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_comp_n</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*comp_n\(.*\)\s*&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
              <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_atom_frac</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*atom_frac\(.*\)\s*&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
              <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span><span class="o">=</span><span class="n">tooltips</span><span class="p">,</span> <span class="n">renderers</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r_dft</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_clex</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">renderers</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r_dft</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_clex</span><span class="p">]))</span>


<div class="viewcode-block" id="ConvexHullPlot._set_on_hull"><a class="viewcode-back" href="../../../python/casm.plotting.ConvexHullPlot.html#casm.plotting.ConvexHullPlot._set_on_hull">[docs]</a>  <span class="k">def</span> <span class="nf">_set_on_hull</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">on_hull_label</span><span class="p">,</span> <span class="n">hull_dist_label</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use the &#39;hull_dist_label&#39; column, and self.hull_tol to create the boolean</span>
<span class="sd">    column &#39;on_hull_label&#39; indicating which configurations are on the hull.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">_unselected</span><span class="p">(</span><span class="n">sel</span><span class="p">),</span> <span class="n">on_hull_label</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">on_hull</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hull_tol</span><span class="p">,</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">_selected</span><span class="p">(</span><span class="n">sel</span><span class="p">),</span> <span class="n">hull_dist_label</span><span class="p">]))</span>
    <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">_selected</span><span class="p">(</span><span class="n">sel</span><span class="p">),</span> <span class="n">on_hull_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">on_hull</span></div>


  <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">force</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># check which hull_selection configurations are calculated</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hull_sel</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="s1">&#39;is_calculated&#39;</span><span class="p">)</span>

    <span class="c1"># store hull_selection.calculated</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hull_sel_calculated</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
      <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;is_calculated&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">],</span>
      <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>


    <span class="c1"># for selection query:</span>
    <span class="c1"># - to plot: x_all, y, y_clex</span>
    <span class="c1"># - for tooltips / dft hull: configname, x_all, hull_dist, clex_hull_dist</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="s1">&#39;is_calculated&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_all</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_clex</span><span class="p">,</span>
      <span class="n">hull_dist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel_calculated</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
      <span class="n">hull_dist_per_atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel_calculated</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
      <span class="n">clex_hull_dist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
      <span class="n">clex_hull_dist_per_atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel</span><span class="o">.</span><span class="n">path</span><span class="p">)]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span><span class="p">,</span>
      <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>

    <span class="c1"># add project and selection path</span>
    <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">path</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="s1">&#39;selection&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">path</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>


    <span class="c1"># convert to numeric (NaN) for configurations without DFT calculations</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">hull_dist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel_calculated</span><span class="o">.</span><span class="n">path</span><span class="p">)]</span> <span class="o">=</span> \
      <span class="n">pandas</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">hull_dist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel_calculated</span><span class="o">.</span><span class="n">path</span><span class="p">)],</span>
        <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">hull_dist_per_atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel_calculated</span><span class="o">.</span><span class="n">path</span><span class="p">)]</span> <span class="o">=</span> \
      <span class="n">pandas</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">hull_dist_per_atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel_calculated</span><span class="o">.</span><span class="n">path</span><span class="p">)],</span>
        <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

    <span class="c1"># find hull points</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_on_hull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;on_dft_hull&#39;</span><span class="p">,</span> <span class="n">hull_dist_per_atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel_calculated</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_on_hull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;on_clex_hull&#39;</span><span class="p">,</span> <span class="n">clex_hull_dist_per_atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_sel</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>

    <span class="c1"># create dft hull selection</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dft_hull_sel</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;on_dft_hull&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>

    <span class="c1"># for selection query:</span>
    <span class="c1">#  - for tooltips: clex_of_dft_hull_dist</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">query</span><span class="p">([</span>
      <span class="n">clex_hull_dist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dft_hull_sel</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
      <span class="n">clex_hull_dist_per_atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dft_hull_sel</span><span class="o">.</span><span class="n">path</span><span class="p">)],</span>
      <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>

    <span class="c1"># find clex_of_dft_hull line</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_on_hull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;on_clex_of_dft_hull&#39;</span><span class="p">,</span> <span class="n">clex_hull_dist_per_atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dft_hull_sel</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>


    <span class="c1"># source for points, tooltips</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
       <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">])</span>

    <span class="c1"># source for hull data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">calc_hull_src</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_dft_hull_line</span><span class="p">())</span>

    <span class="c1"># source for clex hull data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">clex_hull_src</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_clex_hull_line</span><span class="p">())</span>

    <span class="c1"># source for clex of dft hull data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">clex_of_dft_hull_src</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_clex_of_dft_hull_line</span><span class="p">())</span>


<span class="c1">#  def update(self):</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    Enable update of y values</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#    # update y-data</span>
<span class="c1">#    add_hull_data(self.sel, self.hull_sel, self.dft_hull_sel, self.hull_tol, force=True)</span>
<span class="c1">#    add_src_data(self.sel, hull_dist(self.hull_sel.path), self.sel.data.loc[:,hull_dist(self.hull_sel.path)])</span>
<span class="c1">#</span>
<span class="c1">#    self.update_hull_line()</span>
<span class="c1">#    self.update_clex_hull_line()</span>
<span class="c1">#    slef.update_clex_of_dft_hull_line()</span>

<div class="viewcode-block" id="ConvexHullPlot._sort_hull_line"><a class="viewcode-back" href="../../../python/casm.plotting.ConvexHullPlot.html#casm.plotting.ConvexHullPlot._sort_hull_line">[docs]</a>  <span class="k">def</span> <span class="nf">_sort_hull_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">on_hull_label</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return x,y data where &#39;on_hull_label&#39;==True, sorted by x</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># sort hull line data</span>
    <span class="n">on_hull</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">on_hull_label</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">on_hull</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_clex</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">])</span></div>

<div class="viewcode-block" id="ConvexHullPlot.sort_dft_hull_line"><a class="viewcode-back" href="../../../python/casm.plotting.ConvexHullPlot.html#casm.plotting.ConvexHullPlot.sort_dft_hull_line">[docs]</a>  <span class="k">def</span> <span class="nf">sort_dft_hull_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; sort dft hull line data &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sorted_dft_hull</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_hull_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;on_dft_hull&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted_dft_hull</span></div>

  <span class="k">def</span> <span class="nf">sort_clex_hull_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># sort clex hull line data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sorted_clex_hull</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_hull_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;on_clex_hull&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted_clex_hull</span>

  <span class="k">def</span> <span class="nf">sort_clex_of_dft_hull_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># set clex of dft hull line data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sorted_clex_of_dft_hull</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_hull_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;on_clex_of_dft_hull&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted_clex_of_dft_hull</span></div>


<div class="viewcode-block" id="Scatter"><a class="viewcode-back" href="../../../python/casm.plotting.Scatter.html#casm.plotting.Scatter">[docs]</a><span class="k">class</span> <span class="nc">Scatter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Attributes:</span>
<span class="sd">    data:</span>
<span class="sd">    sel: a CASM Selection used to make the figure</span>
<span class="sd">    x: the value of the x-axis, &#39;comp(a)&#39; by default</span>
<span class="sd">    y: the value of the y-axis, &#39;comp(a)&#39; by default</span>
<span class="sd">    legend:</span>
<span class="sd">    index:</span>
<span class="sd">    series_name:</span>
<span class="sd">    style:</span>
<span class="sd">    tooltips:</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Scatter.__init__"><a class="viewcode-back" href="../../../python/casm.plotting.Scatter.html#casm.plotting.Scatter.__init__">[docs]</a>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="s2">&quot;MASTER&quot;</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;comp(a)&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;formation_energy&#39;</span><span class="p">,</span> <span class="n">tooltips</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{},</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">series_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments:</span>
<span class="sd">        data: PlottingData object</span>
<span class="sd">        project: path to CASM project (optional, default=casm.project.project_path())</span>
<span class="sd">        selection: path for CASM Selection</span>
<span class="sd">        x: (str) column name to use as x axis. Default=&#39;comp(a)&#39;</span>
<span class="sd">        y: (str) column name to use as y axis. Default=&#39;formation_energy&#39;</span>
<span class="sd">        tooltips:</span>
<span class="sd">        legend:</span>
<span class="sd">        style:</span>
<span class="sd">        index:</span>
<span class="sd">        series_name:</span>
<span class="sd">        type:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">PlottingData</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

    <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">project_path</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">selection</span> <span class="o">=</span> <span class="s2">&quot;MASTER&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">selection</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">proj_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;verbose&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

    <span class="k">if</span> <span class="n">legend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">y</span>
    <span class="k">elif</span> <span class="n">legend</span> <span class="o">==</span> <span class="s2">&quot;off&quot;</span> <span class="ow">or</span> <span class="n">legend</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">legend</span> <span class="o">=</span> <span class="n">legend</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
    <span class="k">if</span> <span class="n">series_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">series_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span> <span class="o">=</span> <span class="n">series_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">scatter_series_style</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">style</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span> <span class="o">=</span> <span class="n">tooltips</span></div>


  <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">]</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">columns</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
          <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">])</span>

      <span class="c1"># add project and selection path</span>
      <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">path</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="s1">&#39;selection&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">path</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>


  <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tap_action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

      <span class="n">update_scatter_glyphs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span><span class="p">)</span>

      <span class="c1"># avoid having a legend name same as a column name</span>
      <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">legend</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">column_names</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">legend</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;marker&#39;</span><span class="p">])(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
          <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
          <span class="n">size</span><span class="o">=</span><span class="s1">&#39;radii.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span><span class="p">,</span>
          <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;color.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span><span class="p">,</span>
          <span class="n">fill_alpha</span><span class="o">=</span><span class="s1">&#39;fill_alpha.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span><span class="p">,</span>
          <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;line_color.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span><span class="p">,</span>
          <span class="n">line_width</span><span class="o">=</span><span class="s1">&#39;line_width.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span><span class="p">,</span>
          <span class="n">line_alpha</span><span class="o">=</span><span class="s1">&#39;line_alpha.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span><span class="p">,</span>
          <span class="n">hover_alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hover_alpha&#39;</span><span class="p">],</span>
          <span class="n">hover_color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hover_color&#39;</span><span class="p">],</span>
          <span class="n">legend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">legend</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">renderers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">]</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">fig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
          <span class="n">fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>

      <span class="k">if</span> <span class="n">tap_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">tap_action</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="n">casm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">view_on_tap</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">])</span>


      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">tooltips</span> <span class="o">=</span> <span class="p">[]</span>

          <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">]:</span>
              <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">float_dtypes</span><span class="p">:</span>
                  <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span><span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span><span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span><span class="p">))</span>

          <span class="n">fig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span><span class="o">=</span><span class="n">tooltips</span><span class="p">,</span> <span class="n">renderers</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">]))</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="n">fig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">renderers</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">]))</span></div>


<div class="viewcode-block" id="Histogram"><a class="viewcode-back" href="../../../python/casm.plotting.Histogram.html#casm.plotting.Histogram">[docs]</a><span class="k">class</span> <span class="nc">Histogram</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Attributes:</span>
<span class="sd">    data:</span>
<span class="sd">    sel: a CASM Selection used to make the figure</span>
<span class="sd">    x: the value of the x-axis, &#39;comp(a)&#39; by default</span>
<span class="sd">    y: the value of the y-axis, &#39;comp(a)&#39; by default</span>
<span class="sd">    legend:</span>
<span class="sd">    index:</span>
<span class="sd">    series_name:</span>
<span class="sd">    style:</span>
<span class="sd">    tooltips:</span>

<span class="sd">    src:</span>
<span class="sd">    y_label:</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Histogram.__init__"><a class="viewcode-back" href="../../../python/casm.plotting.Histogram.html#casm.plotting.Histogram.__init__">[docs]</a>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="s2">&quot;MASTER&quot;</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;comp(a)&#39;</span><span class="p">,</span> <span class="n">hist_kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">tooltips</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">style</span><span class="o">=</span><span class="p">{},</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">series_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments:</span>
<span class="sd">        data: PlottingData object</span>
<span class="sd">        project: path to CASM project (optional, default=casm.project.project_path())</span>
<span class="sd">        selection: path for CASM Selection</span>
<span class="sd">        x: (str) column name to use as x axis. Default=&#39;comp(a)&#39;</span>
<span class="sd">        hist_kwargs:</span>
<span class="sd">        tooltips:</span>
<span class="sd">        legend:</span>
<span class="sd">        style:</span>
<span class="sd">        index:</span>
<span class="sd">        series_name:</span>
<span class="sd">        type:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">PlottingData</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

    <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">project_path</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">selection</span> <span class="o">=</span> <span class="s2">&quot;MASTER&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">selection</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">proj_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;verbose&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span> <span class="o">=</span> <span class="n">hist_kwargs</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
    <span class="k">if</span> <span class="n">series_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">series_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span> <span class="o">=</span> <span class="n">series_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">scatter_series_style</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">style</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span> <span class="o">=</span> <span class="n">tooltips</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="kc">None</span></div>

  <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
          <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">])</span>

      <span class="k">if</span> <span class="s1">&#39;to_be_selected&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;to_be_selected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span>

      <span class="c1"># add project and selection path</span>
      <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">path</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="s1">&#39;selection&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">path</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>

      <span class="c1"># create histogram data</span>
      <span class="n">tmp_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span><span class="p">)</span>
      <span class="n">tmp_kwargs</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">hist</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">],</span> <span class="o">**</span><span class="n">tmp_kwargs</span><span class="p">)</span>

      <span class="n">sel_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span><span class="p">)</span>
      <span class="n">sel_kwargs</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span>
      <span class="n">sel_kwargs</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

      <span class="n">hist_sel</span><span class="p">,</span> <span class="n">edges_sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;to_be_selected&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
          <span class="o">**</span><span class="n">sel_kwargs</span><span class="p">)</span>

      <span class="c1"># need to do &#39;density&#39; of selected by hand</span>
      <span class="k">if</span> <span class="s1">&#39;density&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]:</span>
           <span class="n">hist_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
           <span class="n">width</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
           <span class="n">area</span> <span class="o">=</span> <span class="n">hist_freq</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
           <span class="n">hist</span> <span class="o">=</span> <span class="n">hist_freq</span><span class="o">*</span><span class="n">width</span><span class="o">/</span><span class="n">area</span>
           <span class="n">hist_sel</span> <span class="o">=</span> <span class="n">hist_sel</span><span class="o">*</span><span class="n">width</span><span class="o">/</span><span class="n">area</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ColumnDataSource</span><span class="p">()</span>
          <span class="n">set_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
          <span class="n">set_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

      <span class="n">set_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">set_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

      <span class="n">set_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;top_sel&quot;</span><span class="p">,</span> <span class="n">hist_sel</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">set_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;top_unsel&quot;</span><span class="p">,</span> <span class="n">hist</span> <span class="o">-</span> <span class="n">hist_sel</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">set_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;bottom_sel&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">hist_sel</span><span class="p">),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

      <span class="k">if</span> <span class="s1">&#39;density&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Frequency&quot;</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Density&quot;</span>


  <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tap_action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

      <span class="n">update_scatter_glyphs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">r_quad</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span>
          <span class="n">top</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
          <span class="n">bottom</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
          <span class="n">left</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
          <span class="n">right</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
          <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
          <span class="n">fill_alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
          <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
          <span class="n">line_width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">r_quad_sel</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span>
          <span class="n">top</span><span class="o">=</span><span class="s1">&#39;top_sel&#39;</span><span class="p">,</span>
          <span class="n">bottom</span><span class="o">=</span><span class="s1">&#39;bottom_sel&#39;</span><span class="p">,</span>
          <span class="n">left</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
          <span class="n">right</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
          <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
          <span class="n">fill_alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">][</span><span class="s1">&#39;fill_alpha&#39;</span><span class="p">],</span>
          <span class="n">fill_color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">],</span>
          <span class="n">line_alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
          <span class="n">line_width</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">renderers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r_quad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_quad_sel</span><span class="p">]</span>

      <span class="n">fig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
      <span class="n">fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_label</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">tooltips</span> <span class="o">=</span> <span class="p">[</span>
              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="s2">&quot;@</span><span class="si">{left}{1.1111}</span><span class="s2">&quot;</span><span class="p">),</span>
              <span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">,</span><span class="s2">&quot;@</span><span class="si">{top_sel}{1.1111}</span><span class="s2">&quot;</span><span class="p">),</span>
              <span class="p">(</span><span class="s2">&quot;unselected&quot;</span><span class="p">,</span><span class="s2">&quot;@</span><span class="si">{top_unsel}{1.1111}</span><span class="s2">&quot;</span><span class="p">),</span>
              <span class="p">(</span><span class="s2">&quot;total&quot;</span><span class="p">,</span><span class="s2">&quot;@</span><span class="si">{top}{1.1111}</span><span class="s2">&quot;</span><span class="p">)</span>
          <span class="p">]</span>

          <span class="n">fig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span><span class="o">=</span><span class="n">tooltips</span><span class="p">,</span> <span class="n">renderers</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r_quad</span><span class="p">]))</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="n">fig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">renderers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">renderers</span><span class="p">))</span></div>


<div class="viewcode-block" id="GridPlot"><a class="viewcode-back" href="../../../python/casm.plotting.GridPlot.html#casm.plotting.GridPlot">[docs]</a><span class="k">class</span> <span class="nc">GridPlot</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Attributes:</span>
<span class="sd">    p: a bokeh Figure containing formation energies and the convex hull</span>
<span class="sd">    layout: a bokeh layout element holding p</span>
<span class="sd">    sel: a CASM Selection used to make the figure</span>
<span class="sd">    x: the value of the x-axis, &#39;comp(a)&#39; by default</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="GridPlot.__init__"><a class="viewcode-back" href="../../../python/casm.plotting.GridPlot.html#casm.plotting.GridPlot.__init__">[docs]</a>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;comp(a)&#39;</span><span class="p">,</span> <span class="s1">&#39;formation_energy&#39;</span><span class="p">],</span>
    <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;comp(a)&#39;</span><span class="p">,</span> <span class="s1">&#39;formation_energy&#39;</span><span class="p">],</span>
    <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments:</span>
<span class="sd">      sel: A CASM Selection</span>
<span class="sd">      x: (list of str) property names to use as x axis</span>
<span class="sd">      y: (list of str) property names to use as x axis</span>
<span class="sd">      type = (list of class names, either Scatter or Histogram)</span>
<span class="sd">      axis = (0 or 1) axis that type refer to</span>
<span class="sd">      kwargs: (list of dict) kwargs to pass to constructors</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="p">[</span><span class="n">Scatter</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="p">[</span><span class="n">Scatter</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
    <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">kwargs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_plot</span><span class="p">()</span>

    <span class="c1"># ensure that changes in &#39;sel.src&#39; will update the histogram</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">selection_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">)</span>

    <span class="c1"># layout</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">GridPlot</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="p">)</span></div>


  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A list of list of bokeh plots&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_plot</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_</span>

  <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="c1"># construct plots</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">casm_p_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">):</span>
      <span class="n">casm_row</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">_x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">_index</span> <span class="o">=</span> <span class="n">j</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">_index</span> <span class="o">=</span> <span class="n">i</span>

        <span class="n">_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
        <span class="n">_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">_type</span> <span class="ow">is</span> <span class="n">Histogram</span><span class="p">:</span>
          <span class="n">casm_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">_x</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">))</span>
          <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">casm_row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">_type</span> <span class="ow">is</span> <span class="n">Scatter</span><span class="p">:</span>
          <span class="n">casm_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">_y</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">))</span>
          <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">casm_row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown or unsupported plot type:&quot;</span><span class="p">,</span> <span class="n">_type</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
          <span class="n">casm_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
          <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">casm_p_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">casm_row</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="c1"># linked panning</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)):</span>
      <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)):</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">x_range</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y_range</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1">#self.casm_p_[r][c].layout = None</span>
        <span class="k">if</span> <span class="n">x_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">x_range</span> <span class="o">=</span> <span class="n">x_range</span>
        <span class="k">if</span> <span class="n">y_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">y_range</span> <span class="o">=</span> <span class="n">y_range</span>

  <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">casm_p_</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">casm_p_</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">casm_p_</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">):</span>
          <span class="n">casm_p_</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>


<div class="viewcode-block" id="RankPlot"><a class="viewcode-back" href="../../../python/casm.plotting.RankPlot.html#casm.plotting.RankPlot">[docs]</a><span class="k">class</span> <span class="nc">RankPlot</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Attributes:</span>
<span class="sd">    sel: a CASM Selection used to make the figure</span>
<span class="sd">    score_id: a UUID to use for the &#39;score&#39; column name in the sel.src ColumnDataSource</span>
<span class="sd">    rank_id: a UUID to use for the &#39;rank&#39; column name in the sel.src ColumnDataSource</span>
<span class="sd">    max_score: the maximum score</span>
<span class="sd">    min_score: the minimum score</span>
<span class="sd">  &quot;&quot;&quot;</span>
<div class="viewcode-block" id="RankPlot.__init__"><a class="viewcode-back" href="../../../python/casm.plotting.RankPlot.html#casm.plotting.RankPlot.__init__">[docs]</a>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="s2">&quot;MASTER&quot;</span><span class="p">,</span> <span class="n">to_query</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">scoring_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scoring_module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scoring_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tooltips</span><span class="o">=</span><span class="p">[],</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="p">{},</span> <span class="n">series_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments:</span>
<span class="sd">      data: PlottingData instance</span>
<span class="sd">      project: str (optional, default=casm.project.project_path())</span>
<span class="sd">      selection: str (optional, default=&quot;MASTER&quot;)</span>
<span class="sd">      query: List[str]</span>
<span class="sd">      scoring_query: str</span>
<span class="sd">      scoring_module: str</span>
<span class="sd">      scoring_function: str</span>
<span class="sd">      tooltips: List[str]</span>
<span class="sd">      tooltips_exclude: List[str]</span>
<span class="sd">      index: int</span>
<span class="sd">      type: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">PlottingData</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

    <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">project_path</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">selection</span> <span class="o">=</span> <span class="s2">&quot;MASTER&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">selection</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">proj_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;verbose&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">scoring_query</span> <span class="o">=</span> <span class="n">scoring_query</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">to_query</span> <span class="o">=</span> <span class="n">to_query</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scoring_module</span> <span class="o">=</span> <span class="n">scoring_module</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scoring_function</span> <span class="o">=</span> <span class="n">scoring_function</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoring_query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoring_query</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_query</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_query</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scoring_query</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">rankplot_style</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">style</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
    <span class="k">if</span> <span class="n">series_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">series_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span> <span class="o">=</span> <span class="n">series_name</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span> <span class="o">=</span> <span class="n">tooltips</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">scoring_query</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">scoring_module</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">scoring_function</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">score_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_max_score</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_min_score</span> <span class="o">=</span> <span class="kc">None</span></div>


  <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tap_action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">update_scatter_glyphs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">r_stem</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
      <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;line_color.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span><span class="p">,</span>
      <span class="n">line_width</span><span class="o">=</span><span class="s1">&#39;line_width.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span><span class="p">,</span>
      <span class="n">line_alpha</span><span class="o">=</span><span class="s1">&#39;line_alpha.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span><span class="p">,</span>
      <span class="n">hover_alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hover_alpha&#39;</span><span class="p">],</span>
      <span class="n">hover_color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hover_color&#39;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">r_circ</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span><span class="p">,</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">,</span>
      <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
      <span class="n">size</span><span class="o">=</span><span class="s1">&#39;radii.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span><span class="p">,</span>
      <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;color.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span><span class="p">,</span>
      <span class="n">fill_alpha</span><span class="o">=</span><span class="s1">&#39;fill_alpha.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_name</span><span class="p">,</span>
      <span class="n">line_width</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
      <span class="n">line_alpha</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
      <span class="n">hover_alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hover_alpha&#39;</span><span class="p">],</span>
      <span class="n">hover_color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hover_color&#39;</span><span class="p">])</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;Rank&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">renderers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r_stem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_circ</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">tap_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tap_action</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="n">casm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">view_on_tap</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r_circ</span><span class="p">])</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tooltips</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span><span class="p">]:</span>

            <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">:</span>
                <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;score&quot;</span><span class="p">,</span><span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_id</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span><span class="p">:</span>
                <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;rank&quot;</span><span class="p">,</span><span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">float_dtypes</span><span class="p">:</span>
                <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span><span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tooltips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span><span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span><span class="o">=</span><span class="n">tooltips</span><span class="p">,</span> <span class="n">renderers</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r_circ</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">renderers</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r_circ</span><span class="p">]))</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">max_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_max_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">])</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_score</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">min_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_min_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">])</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_score</span>

<div class="viewcode-block" id="RankPlot.score"><a class="viewcode-back" href="../../../python/casm.plotting.RankPlot.html#casm.plotting.RankPlot.score">[docs]</a>  <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate &#39;score&#39; and &#39;rank&#39;, but do not change selection. May also change the</span>
<span class="sd">    &#39;scoring&#39; function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoring_query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">scoring_query</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scoring_query:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoring_query</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;columns:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scoring_module</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scoring_module</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoring_function</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># convert to numeric (NaN)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

    <span class="c1"># add &#39;score&#39; to src, as self.score_id</span>
    <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># rank</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">,</span> <span class="s1">&#39;configname&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># add &#39;rank&#39; to src as self.rank_id</span>
    <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_min_score</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_max_score</span> <span class="o">=</span> <span class="kc">None</span></div>

  <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_query</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># add project and selection path</span>
    <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">path</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="s1">&#39;selection&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">path</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="s1">&#39;configname&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">()</span></div>


<span class="k">class</span> <span class="nc">RankSelect</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Attributes:</span>
<span class="sd">    p: a bokeh Figure containing formation energies and the convex hull</span>
<span class="sd">    layout: a bokeh layout element holding p</span>
<span class="sd">    sel: a CASM Selection used to make the figure</span>
<span class="sd">    scoring: a scoring function to operate on a row of sel.data</span>
<span class="sd">    score_id: a UUID to use for the &#39;score&#39; column name in the sel.src ColumnDataSource</span>
<span class="sd">    rank_id: a UUID to use for the &#39;rank&#39; column name in the sel.src ColumnDataSource</span>
<span class="sd">    max_score: the maximum score</span>
<span class="sd">    min_score: the minimum score</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">scoring</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Score&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;set&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments:</span>
<span class="sd">      sel: A CASM Selection</span>
<span class="sd">      scoring: (function) a scoring function to operate on a row of sel.data</span>
<span class="sd">      name: y-axis label to describe the scoring function</span>
<span class="sd">      mode: (str) &#39;set&#39;, &#39;set_on&#39;, &#39;set_off&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">scoring</span> <span class="o">=</span> <span class="n">scoring</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="s1">&#39;set_on&#39;</span><span class="p">,</span> <span class="s1">&#39;set_off&#39;</span><span class="p">]:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode: &quot;</span> <span class="o">+</span> <span class="n">mode</span> <span class="o">+</span> <span class="s2">&quot; not allowed. Expected &#39;set&#39;, &#39;set_on&#39;, or &#39;set_off&#39;&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">score_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_max_score</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_min_score</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># TOOLS in bokeh plot</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="s2">&quot;crosshair,pan,reset,box_zoom,wheel_zoom,save&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># bokeh DataSource for cutoff line</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_line_src</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># construct pre-score widgets</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pre_score_input</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">()</span>

    <span class="c1"># construct post-score widgets</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_post_score_input</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_plot</span><span class="p">()</span>

    <span class="c1"># store plot in layout with widgets</span>
    <span class="n">_hplot</span> <span class="o">=</span> <span class="n">bk_layouts</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_action</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">bk_layouts</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">_hplot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">plot_width</span><span class="p">)</span>


  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_plot</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_</span>

  <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="c1"># add &#39;style&#39; to the selection if not already existing</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;dft_style&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">dft_style</span> <span class="o">=</span> <span class="n">dft_style</span>
      <span class="n">update_glyphs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">)</span>

    <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">dft_style</span>

    <span class="n">_tools</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mouse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">p_</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">plot_width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">plot_height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">_tools</span><span class="p">)</span>
    <span class="n">p_stem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
      <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
      <span class="n">hover_alpha</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hover_alpha&#39;</span><span class="p">],</span> <span class="n">hover_color</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hover_color&#39;</span><span class="p">])</span>

    <span class="n">p_circ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
      <span class="n">size</span><span class="o">=</span><span class="s1">&#39;radii&#39;</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;fill_alpha&#39;</span><span class="p">],</span>
      <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;line_color&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="s1">&#39;line_width&#39;</span><span class="p">,</span> <span class="n">line_alpha</span><span class="o">=</span><span class="s1">&#39;line_alpha&#39;</span><span class="p">,</span>
      <span class="n">hover_alpha</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hover_alpha&#39;</span><span class="p">],</span> <span class="n">hover_color</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;hover_color&#39;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;Rank&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;Score&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="c1"># hover over a point to see &#39;configname&#39;, &#39;score&#39;, Ef&#39;, and &#39;comp(a)&#39;</span>
      <span class="n">tooltips</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">(</span><span class="s2">&quot;configname&quot;</span><span class="p">,</span><span class="s2">&quot;@configname&quot;</span><span class="p">),</span>
          <span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">,</span><span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_id</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">),</span>
          <span class="p">(</span><span class="s2">&quot;rank&quot;</span><span class="p">,</span><span class="s2">&quot;@{&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="si">{1.1111}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="p">]</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_line_src</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_line_src</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ColumnDataSource</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
          <span class="s1">&#39;x&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
          <span class="s1">&#39;y&#39;</span><span class="p">:[</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
        <span class="p">})</span>

      <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_line_src</span><span class="o">.</span><span class="n">on_change</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">CrosshairTool</span><span class="p">)</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>

    <span class="n">p_click</span><span class="o">=</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">CustomJS</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;src&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff_line_src</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mouse_location_src</span><span class="p">},</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      var data = src.data;</span>
<span class="s2">      var loc_data = loc.data;</span>
<span class="s2">      data[&#39;y&#39;][0] = loc_data[&#39;y&#39;][0];</span>
<span class="s2">      data[&#39;y&#39;][1] = loc_data[&#39;y&#39;][0];</span>
<span class="s2">      src.data = data;</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">CrosshairTool</span><span class="p">)</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">TapTool</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="n">p_click</span><span class="p">))</span>

    <span class="n">p_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff_line_src</span><span class="p">,</span>
      <span class="n">line_width</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;cutoff_line_width&#39;</span><span class="p">],</span> <span class="n">line_alpha</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;cutoff_alpha&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="s1">&#39;cutoff_color&#39;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tooltips</span><span class="p">,</span> <span class="n">renderers</span><span class="o">=</span><span class="p">[</span><span class="n">p_circ</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p_</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">BoxSelectTool</span><span class="p">(</span><span class="n">renderers</span><span class="o">=</span><span class="p">[</span><span class="n">p_circ</span><span class="p">]))</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">max_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_max_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">])</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_score</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">min_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_min_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">])</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_score</span>

  <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate &#39;score&#39; and &#39;rank&#39;, but do not change selection. May also change the</span>
<span class="sd">    &#39;scoring&#39; function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">scoring</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">scoring</span> <span class="o">=</span> <span class="n">scoring</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="c1"># score</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scoring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">])</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error applying scoring function&quot;</span><span class="p">)</span>
      <span class="k">raise</span>

    <span class="c1"># add &#39;score&#39; to src, as self.score_id</span>
    <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># rank</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;score&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># add &#39;rank&#39; to src as self.rank_id</span>
    <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_pre_score_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct gui widgets</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">### mouse location</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mouse_location_src</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">]})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mouse</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">HoverTool</span><span class="p">(</span>
      <span class="n">tooltips</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">callback</span><span class="o">=</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">CustomJS</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mouse_location_src</span><span class="p">},</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        var data = src.data;</span>
<span class="s2">        data[&#39;y&#39;][0] = cb_data.geometry.y;</span>
<span class="s2">        data[&#39;y&#39;][1] = cb_data.geometry.y;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">Messages</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">select_mode</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Select</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="s2">&quot;set_on&quot;</span><span class="p">,</span> <span class="s2">&quot;set_off&quot;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">select_mode_f</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">new</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">update_cutoff</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">select_mode</span><span class="o">.</span><span class="n">on_change</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">select_mode_f</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">select_action</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Select</span><span class="p">(</span>
      <span class="n">value</span><span class="o">=</span><span class="s2">&quot;Select action&quot;</span><span class="p">,</span>
      <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Select action&quot;</span><span class="p">,</span> <span class="s2">&quot;Revert&quot;</span><span class="p">,</span> <span class="s2">&quot;Apply&quot;</span><span class="p">,</span> <span class="s2">&quot;Apply and Save&quot;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">select_action_f</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">new</span> <span class="o">==</span> <span class="s2">&quot;Revert&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;to_be_selected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">update_selection</span><span class="p">()</span>
        <span class="n">update_glyphs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="n">selected</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;to_be_selected&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;Reverted to last applied selection&quot;</span>
      <span class="k">elif</span> <span class="n">new</span> <span class="o">==</span> <span class="s2">&quot;Apply&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;to_be_selected&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">update_selection</span><span class="p">()</span>
        <span class="n">update_glyphs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="n">selected</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;to_be_selected&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;Applied selection&quot;</span>
      <span class="k">elif</span> <span class="n">new</span> <span class="o">==</span> <span class="s2">&quot;Apply and Save&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;to_be_selected&#39;</span><span class="p">]</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">update_selection</span><span class="p">()</span>
          <span class="n">update_glyphs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="n">selected</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;to_be_selected&#39;</span><span class="p">])</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;Applied selection and saved: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">path</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">select_action</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;Select action&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">select_action</span><span class="o">.</span><span class="n">on_change</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">select_action_f</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_post_score_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct gui widgets</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FloatInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_score</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Cutoff:&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_cutoff</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">update_cutoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update self.sel.data[&#39;selected&#39;], update_glyphs(self.sel), update cutoff line.</span>
<span class="sd">    Ignores &#39;attrname&#39;, &#39;old&#39;, and &#39;new&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">f</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span>
      <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_f</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;set_on&#39;</span><span class="p">:</span>
      <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_on_f</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;set_off&#39;</span><span class="p">:</span>
      <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_off_f</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;to_be_selected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
    <span class="n">set_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff_line_src</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">update_selection</span><span class="p">()</span>
    <span class="n">update_glyphs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="n">selected</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;to_be_selected&#39;</span><span class="p">])</span>


  <span class="k">def</span> <span class="nf">_set_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

  <span class="k">def</span> <span class="nf">_set_on_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">_set_off_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;selected&#39;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">WeightSelect</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">input_filename</span><span class="o">=</span><span class="s2">&quot;fit_input.json&quot;</span><span class="p">,</span>
    <span class="n">hullplot_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">A_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">B_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kT_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Eref_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show_weightplot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interactively set weights, via wHullDist.</span>

<span class="sd">    Weights for selected configurations are applied using: A*np.exp(-hull_dist/kT) + B</span>
<span class="sd">    Weights for unselected configurations are set to 1.0</span>

<span class="sd">    Arguments:</span>
<span class="sd">      sel: A CASM Selection to use for the training set</span>
<span class="sd">      input_filename: The name of a fitting input file. Defaults to &quot;fit_input.json&quot;.</span>
<span class="sd">        If input_filename does not exist a default with that name is created.</span>
<span class="sd">      hullplot_kwargs: (dict) kwargs to pass to convex hull plots of formation energy</span>
<span class="sd">        and weighted formation energy</span>
<span class="sd">      A_params, B_params, kT_params: (dict) Settings for input sliders. Options are:</span>
<span class="sd">        &#39;title&#39;, &#39;value&#39;, &#39;start&#39;, &#39;end&#39;, and &#39;step&#39;. Units on kT are meV.</span>
<span class="sd">      show_weightplot: (boolean) Show a plot of sample weight values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input_filename</span> <span class="o">=</span> <span class="n">input_filename</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hullplot_kwargs</span> <span class="o">=</span> <span class="n">hullplot_kwargs</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">input_filename</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fit_input</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">example_input</span><span class="p">()</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_input</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fit_input</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

    <span class="c1"># create select box with weighting method options</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">select_method</span> <span class="o">=</span> <span class="n">SelectInput</span><span class="p">(</span>
      <span class="n">value</span><span class="o">=</span><span class="s2">&quot;wHullDist&quot;</span><span class="p">,</span>
      <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;wHullDist&quot;</span><span class="p">,</span> <span class="s2">&quot;wEmin&quot;</span><span class="p">,</span> <span class="s2">&quot;wEref&quot;</span><span class="p">],</span>
      <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Select Method:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_method</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">select_method</span><span class="o">.</span><span class="n">update</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_method</span>

    <span class="c1"># create sliders for input of parameters, first set ranges</span>
    <span class="n">weight_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_input</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">A_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">A_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span><span class="mf">10.0</span><span class="p">}</span>
      <span class="k">if</span> <span class="s1">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">weight_kwargs</span><span class="p">:</span>
        <span class="n">A_params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight_kwargs</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">A_params</span> <span class="o">=</span> <span class="n">A_params</span>

    <span class="k">if</span> <span class="n">B_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">B_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span><span class="mf">10.0</span><span class="p">}</span>
      <span class="k">if</span> <span class="s1">&#39;B&#39;</span> <span class="ow">in</span> <span class="n">weight_kwargs</span><span class="p">:</span>
        <span class="n">B_params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight_kwargs</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">B_params</span> <span class="o">=</span> <span class="n">B_params</span>

    <span class="k">if</span> <span class="n">kT_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">kT_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;kT (meV)&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="mf">10.0</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span><span class="mf">100.0</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">}</span>
      <span class="k">if</span> <span class="s1">&#39;kT&#39;</span> <span class="ow">in</span> <span class="n">weight_kwargs</span><span class="p">:</span>
        <span class="n">kT_params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight_kwargs</span><span class="p">[</span><span class="s1">&#39;kT&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kT_params</span> <span class="o">=</span> <span class="n">kT_params</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">Ef_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;formation_energy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Ef_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;formation_energy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ef_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ef_min</span>
    <span class="k">if</span> <span class="n">Eref_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">Eref_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;Eref (meV)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Ef_min</span><span class="p">,</span>
        <span class="s2">&quot;start&quot;</span><span class="p">:(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ef_min</span> <span class="o">-</span> <span class="n">delta</span><span class="o">*</span><span class="mf">1.0</span><span class="p">),</span>
        <span class="s2">&quot;end&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Ef_max</span><span class="p">,</span>
        <span class="s2">&quot;step&quot;</span><span class="p">:</span><span class="mf">0.001</span><span class="p">}</span>
      <span class="k">if</span> <span class="s1">&#39;Eref&#39;</span> <span class="ow">in</span> <span class="n">weight_kwargs</span><span class="p">:</span>
        <span class="n">Eref_params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight_kwargs</span><span class="p">[</span><span class="s1">&#39;Eref&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Eref_params</span> <span class="o">=</span> <span class="n">Eref_params</span>

    <span class="c1"># create input widgets</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">A_params</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">B_params</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;kT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kT_params</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;Eref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">Eref_params</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">widget</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">):</span>
      <span class="n">widget</span><span class="o">.</span><span class="n">on_change</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_wvalue</span><span class="p">)</span>

    <span class="c1"># create select action input</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">Messages</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">select_action</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Select</span><span class="p">(</span>
      <span class="n">value</span><span class="o">=</span><span class="s2">&quot;Select action&quot;</span><span class="p">,</span>
      <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Select action&quot;</span><span class="p">,</span> <span class="s2">&quot;Revert&quot;</span><span class="p">,</span> <span class="s2">&quot;Apply&quot;</span><span class="p">,</span> <span class="s2">&quot;Apply and Save&quot;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">select_action_f</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">new</span> <span class="o">==</span> <span class="s2">&quot;Revert&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_revert</span><span class="p">()</span>
      <span class="k">elif</span> <span class="n">new</span> <span class="o">==</span> <span class="s2">&quot;Apply&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">()</span>
      <span class="k">elif</span> <span class="n">new</span> <span class="o">==</span> <span class="s2">&quot;Apply and Save&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_and_save</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">select_action</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;Select action&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">select_action</span><span class="o">.</span><span class="n">on_change</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">select_action_f</span><span class="p">)</span>

    <span class="c1"># callbacks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">selection_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_selection</span><span class="p">)</span>

    <span class="c1"># add weighted property value to self.sel.src</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wvalue_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

    <span class="c1"># add convex hull plot</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hullplot</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">show_weightplot</span> <span class="o">=</span> <span class="n">show_weightplot</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weightplot</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">whullplot</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ref_line</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plot_width</span> <span class="o">=</span> <span class="mi">400</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_selection</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>


  <span class="k">def</span> <span class="nf">_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">A_params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">B_params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kT_params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;kT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Eref_params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;Eref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;Applied sample weights&quot;</span>

  <span class="k">def</span> <span class="nf">_revert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;kT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT_params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;Eref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eref_params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;Reverted to last applied sample weights&quot;</span>

  <span class="k">def</span> <span class="nf">_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fit_input</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">][</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_method</span><span class="o">.</span><span class="n">value</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fit_input</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">][</span><span class="s2">&quot;kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fit_input</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">][</span><span class="s2">&quot;kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fit_input</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">][</span><span class="s2">&quot;kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;kT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;kT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_method</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;wEref&quot;</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_input</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">][</span><span class="s2">&quot;kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;Eref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;Eref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_input</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;Saved input file: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_filename</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_apply_and_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;Applied sample weights and saved input file: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_filename</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set wvalue based on weighting parameters&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">wvalue_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;formation_energy&#39;</span><span class="p">]</span>
    <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wvalue_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">wvalue_id</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_set_wvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set wvalue based on weighting parameters&quot;&quot;&quot;</span>
    <span class="c1"># calculate weights</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_method</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;wHullDist&quot;</span><span class="p">:</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">wHullDist</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hull_dist_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;kT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_method</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;wEmin&quot;</span><span class="p">:</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">wEmin</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;formation_energy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;kT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_method</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;wEref&quot;</span><span class="p">:</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">wEref</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;formation_energy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;kT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="mf">0.001</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;Eref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected</span><span class="p">,</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
    <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;weight&#39;</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># update data (will update hullplot scatter points, but not convex hull line)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">wvalue_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">casm</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">set_sample_weight</span><span class="p">(</span>
      <span class="n">w</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected</span><span class="p">,</span><span class="s1">&#39;formation_energy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_unselected</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">wvalue_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_unselected</span><span class="p">,</span><span class="s1">&#39;formation_energy&#39;</span><span class="p">]</span>
    <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wvalue_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">wvalue_id</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_update_wvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update due to changes in weighting paramaters, but no change in selection&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_wvalue</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_method</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;wEmin&quot;</span><span class="p">,</span> <span class="s2">&quot;wEref&quot;</span><span class="p">]</span> <span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_line_src</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ColumnDataSource</span><span class="p">(</span>
          <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:[</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;Eref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;Eref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hullplot</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_line_src</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_method</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;wEref&quot;</span><span class="p">:</span>
        <span class="n">set_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_line_src</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">set_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_line_src</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;Eref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;Eref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_method</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;wEmin&quot;</span><span class="p">:</span>
        <span class="n">set_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_line_src</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">set_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_line_src</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Ef_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ef_min</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_method</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;wHullDist&quot;</span><span class="p">:</span>
        <span class="n">set_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_line_src</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">set_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_line_src</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_method</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;wEref&quot;</span><span class="p">:</span>
      <span class="n">set_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_line_src</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;Eref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;Eref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">whullplot</span><span class="o">.</span><span class="n">update_hull_line</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_update_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update to reflect change in selection&quot;&quot;&quot;</span>

    <span class="c1"># use the unweighted values to initially plot the hull</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_value</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hullplot_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">hullplot_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
    <span class="n">hullplot_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hullplot_kwargs</span>

    <span class="c1"># add convex hull plot, using unweighted formation energies</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hullplot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">hullplot_kwargs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;formation_energy&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">hullplot</span> <span class="o">=</span> <span class="n">ConvexHullPlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">hullplot_kwargs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">hullplot</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">plot_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_width</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">hullplot</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;Formation Energy&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hullplot</span><span class="o">.</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hullplot</span><span class="o">.</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">whullplot</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_weightplot</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightplot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">weightplot</span> <span class="o">=</span> <span class="n">Scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hullplot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">weightplot</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">plot_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_width</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">weightplot</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;Weight&quot;</span>

    <span class="c1"># add convex hull plot, using unweighted formation energies</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whullplot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">hullplot_kwargs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wvalue_id</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">whullplot</span> <span class="o">=</span> <span class="n">ConvexHullPlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">hullplot_kwargs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">whullplot</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">plot_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_width</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">whullplot</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;Weighted Formation Energy&quot;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">whullplot</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="c1"># set weights and update the hullplot</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hull_dist_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">hull_dist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">path</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_selected</span> <span class="o">=</span> <span class="n">_selected</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_unselected</span> <span class="o">=</span> <span class="n">_unselected</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_wvalue</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;Save selection to re-calculate the convex hull&quot;</span>

    <span class="c1"># Set up layouts and add to document</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_update_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widget_layout</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_wvalue</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_weightplot</span><span class="p">:</span>
      <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hullplot</span><span class="o">.</span><span class="n">layout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">whullplot</span><span class="o">.</span><span class="n">layout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightplot</span><span class="o">.</span><span class="n">layout</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hullplot</span><span class="o">.</span><span class="n">layout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">whullplot</span><span class="o">.</span><span class="n">layout</span><span class="p">]</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">GridPlot</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">children</span><span class="p">])</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">bk_layouts</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">bk_layouts</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_widget_layout</span><span class="p">()),</span> <span class="n">grid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bk_layouts</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">whullplot</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">plot_width</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">300</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_widget_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_method</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;wHullDist&quot;</span><span class="p">,</span> <span class="s2">&quot;wEmin&quot;</span><span class="p">]:</span>
      <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">select_method</span><span class="o">.</span><span class="n">widget</span><span class="p">,</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;kT&#39;</span><span class="p">],</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">],</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">],</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">select_action</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">select_method</span><span class="o">.</span><span class="n">widget</span><span class="p">,</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;kT&#39;</span><span class="p">],</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">],</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">],</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s1">&#39;Eref&#39;</span><span class="p">],</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">select_action</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">ECISelection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">input_filename</span><span class="o">=</span><span class="s2">&quot;fit_input.json&quot;</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">      proj: a casm.Project instance</span>

<span class="sd">      input_filename: str, optional, default &quot;fit_input.json&quot;</span>
<span class="sd">        The name of the fitting input file</span>

<span class="sd">      cwd: str, optional, default current working directory</span>
<span class="sd">        The directory containing input_filename</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">input_filename</span><span class="p">,)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fit_input</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="n">halloffame_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;halloffame_filename&quot;</span><span class="p">,</span> <span class="s2">&quot;halloffame.pkl&quot;</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hall</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">halloffame_filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">indiv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hall</span><span class="p">):</span>
      <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;selected&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;index&quot;</span><span class="p">:</span><span class="n">index</span><span class="p">,</span>
        <span class="s2">&quot;Nbfunc&quot;</span><span class="p">:</span><span class="nb">sum</span><span class="p">(</span><span class="n">indiv</span><span class="p">),</span>
        <span class="s2">&quot;cv&quot;</span><span class="p">:</span><span class="n">indiv</span><span class="o">.</span><span class="n">fitness</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s2">&quot;rms&quot;</span><span class="p">:</span><span class="n">indiv</span><span class="o">.</span><span class="n">rms</span><span class="p">,</span>
        <span class="s2">&quot;wrms:&quot;</span><span class="p">:</span><span class="n">indiv</span><span class="o">.</span><span class="n">wrms</span><span class="p">,</span>
        <span class="s2">&quot;estimator_method&quot;</span><span class="p">:</span><span class="n">indiv</span><span class="o">.</span><span class="n">estimator_method</span><span class="p">,</span>
        <span class="s2">&quot;feature_selection_method&quot;</span><span class="p">:</span><span class="n">indiv</span><span class="o">.</span><span class="n">feature_selection_method</span><span class="p">,</span>
        <span class="s2">&quot;note&quot;</span><span class="p">:</span><span class="n">indiv</span><span class="o">.</span><span class="n">note</span><span class="p">}</span>
      <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># shape: (#bfunc, #indiv)</span>
    <span class="n">eci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">indiv</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hall</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">indiv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hall</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">bfunc</span> <span class="ow">in</span> <span class="n">indiv</span><span class="o">.</span><span class="n">eci</span><span class="p">:</span>
        <span class="n">eci</span><span class="p">[</span><span class="n">bfunc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">bfunc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">eci</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">eci</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hall</span><span class="p">))])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="kc">None</span>



<span class="k">class</span> <span class="nc">ECISelect</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">input_filename</span><span class="o">=</span><span class="s2">&quot;fit_input.json&quot;</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">      proj: a casm.Project instance</span>

<span class="sd">      input_filename: str, optional, default &quot;fit_input.json&quot;</span>
<span class="sd">        The name of the fitting input file</span>

<span class="sd">      cwd: str, optional, default current working directory</span>
<span class="sd">        The directory containing input_filename</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">proj</span> <span class="o">=</span> <span class="n">proj</span>

    <span class="k">if</span> <span class="n">cwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span> <span class="o">=</span> <span class="n">ECISelection</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">input_filename</span><span class="p">,</span> <span class="n">cwd</span><span class="p">)</span>

    <span class="c1"># rankplot: showing cv</span>
    <span class="c1"># scatter plot or median plot of all indiv</span>
    <span class="c1"># indiv plot: value vs bfunc index, colored by branch</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cv_rankplot</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_eci_stemplot</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">bk_layouts</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cv_rankplot</span><span class="o">.</span><span class="n">layout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eci_stemplot</span><span class="p">)</span>


  <span class="k">def</span> <span class="nf">_cv_rankplot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">tooltips</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;Index&quot;</span><span class="p">,</span><span class="s2">&quot;@</span><span class="si">{index}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;CV score&quot;</span><span class="p">,</span><span class="s2">&quot;@</span><span class="si">{cv}{1.1111}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;#Basis Functions&quot;</span><span class="p">,</span> <span class="s2">&quot;@</span><span class="si">{Nbfunc}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Estimator&quot;</span><span class="p">,</span><span class="s2">&quot;@</span><span class="si">{estimator_method}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Selection&quot;</span><span class="p">,</span><span class="s2">&quot;@</span><span class="si">{feature_selection_method}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Note&quot;</span><span class="p">,</span><span class="s2">&quot;@</span><span class="si">{note}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>
    <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="s2">&quot;cv&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cv&quot;</span><span class="p">])</span>
    <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="s2">&quot;estimator_method&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;estimator_method&quot;</span><span class="p">])</span>
    <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="s2">&quot;feature_selection_method&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;feature_selection_method&quot;</span><span class="p">])</span>
    <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="s2">&quot;note&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;note&quot;</span><span class="p">])</span>
    <span class="n">add_src_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="s2">&quot;Nbfunc&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Nbfunc&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="n">sel</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">sel</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;cv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">def</span> <span class="nf">_update_eci_stemplot</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Change viewed individual on tap</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tap!&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">selected</span><span class="p">[</span><span class="s1">&#39;1d&#39;</span><span class="p">][</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;update!&quot;</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">selected</span><span class="p">[</span><span class="s1">&#39;1d&#39;</span><span class="p">][</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">set_src_data</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">eci_src</span><span class="p">,</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span> <span class="n">sel</span><span class="o">.</span><span class="n">eci_src</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># self, sel, scoring, name=&quot;Score&quot;, mode=&#39;set&#39;, tooltips=None, on_tap=view_on_tap)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cv_rankplot</span> <span class="o">=</span> <span class="n">RankPlot</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CV Score&quot;</span><span class="p">,</span>
      <span class="n">tooltips</span><span class="o">=</span><span class="n">tooltips</span><span class="p">,</span> <span class="n">on_tap</span><span class="o">=</span><span class="n">_update_eci_stemplot</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">cv_rankplot</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;Individual&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cv_rankplot</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">plot_width</span> <span class="o">=</span> <span class="mi">400</span>

  <span class="k">def</span> <span class="nf">_eci_stemplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">eci_src</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">eci</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">dir</span><span class="o">.</span><span class="n">basis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">default_clex</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

    <span class="n">set_src_data</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">eci_src</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">eci</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">set_src_data</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">eci_src</span><span class="p">,</span> <span class="s1">&#39;branch&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="s2">&quot;orbit&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">[</span><span class="s2">&quot;cluster_functions&quot;</span><span class="p">]</span> <span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">set_src_data</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">eci_src</span><span class="p">,</span> <span class="s1">&#39;mult&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="s2">&quot;mult&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">[</span><span class="s2">&quot;cluster_functions&quot;</span><span class="p">]</span> <span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">set_src_data</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">eci_src</span><span class="p">,</span> <span class="s1">&#39;max_length&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="s2">&quot;prototype&quot;</span><span class="p">][</span><span class="s2">&quot;max_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">[</span><span class="s2">&quot;cluster_functions&quot;</span><span class="p">]</span> <span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">set_src_data</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">eci_src</span><span class="p">,</span> <span class="s1">&#39;min_length&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="s2">&quot;prototype&quot;</span><span class="p">][</span><span class="s2">&quot;min_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">[</span><span class="s2">&quot;cluster_functions&quot;</span><span class="p">]</span> <span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">colormap</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;cyan&quot;</span><span class="p">,</span> <span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">]</span>
    <span class="n">set_src_data</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">eci_src</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">colormap</span><span class="p">[</span><span class="n">x</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colormap</span><span class="p">)],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">eci_src</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">])),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">set_src_data</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">eci_src</span><span class="p">,</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">eci_src</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># TOOLS in bokeh plot</span>
    <span class="n">_tools</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;crosshair,pan,reset,box_zoom,wheel_zoom,save&quot;</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">eci_stemplot</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">plot_width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">plot_height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
      <span class="n">tools</span><span class="o">=</span><span class="n">_tools</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">eci</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">1.1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">eci</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.1</span><span class="p">))</span>
    <span class="n">p_stem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eci_stemplot</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;current&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">eci_src</span><span class="p">,</span>
      <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="n">p_circ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eci_stemplot</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;current&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">eci_src</span><span class="p">,</span>
      <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">eci_stemplot</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;Basis Function Index&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">eci_stemplot</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;ECI Value&quot;</span>

    <span class="c1"># hover over a point to see &#39;ECI&#39;, other info on basis function/cluster</span>
    <span class="n">tooltips</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;Index&quot;</span><span class="p">,</span><span class="s2">&quot;@</span><span class="si">{index}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ECI&quot;</span><span class="p">,</span><span class="s2">&quot;@</span><span class="si">{current}{1.1111}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Cluster size&quot;</span><span class="p">,</span><span class="s2">&quot;@</span><span class="si">{branch}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Multiplicity&quot;</span><span class="p">,</span> <span class="s2">&quot;@</span><span class="si">{mult}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Max length&quot;</span><span class="p">,</span> <span class="s2">&quot;@</span><span class="si">{max_length}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Min length&quot;</span><span class="p">,</span> <span class="s2">&quot;@</span><span class="si">{min_length}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">eci_stemplot</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span><span class="o">=</span><span class="n">tooltips</span><span class="p">,</span> <span class="n">renderers</span><span class="o">=</span><span class="p">[</span><span class="n">p_circ</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">eci_stemplot</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">BoxSelectTool</span><span class="p">(</span><span class="n">renderers</span><span class="o">=</span><span class="p">[</span><span class="n">p_circ</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">eci_stemplot</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">LassoSelectTool</span><span class="p">(</span><span class="n">renderers</span><span class="o">=</span><span class="p">[</span><span class="n">p_circ</span><span class="p">]))</span>


<span class="k">class</span> <span class="nc">FloatInput</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Input a float, and run actions on change of value.</span>

<span class="sd">  Attributes:</span>
<span class="sd">    self.widget: a bokeh.models.TextInput containing the value</span>
<span class="sd">    self.update: A list of callables that should be called on changes of the cutoff value.</span>
<span class="sd">      Signature should be f(attrname, old, new), where &#39;old&#39; and &#39;new&#39; are float.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Float input:&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments:</span>
<span class="sd">      value: Value to use for cutoff.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">TextInput</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">on_change</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_change</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">on_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
      <span class="n">f</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">old</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">new</span><span class="p">))</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

  <span class="nd">@value</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SelectInput</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  A dropdown selection menu.</span>

<span class="sd">  Attributes:</span>
<span class="sd">    self.widget: a bokeh.models.Select containing the cutoff value</span>
<span class="sd">    self.update: a dict of option name str -&gt; list of callables that should be</span>
<span class="sd">      called on change of value</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Select:&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments:</span>
<span class="sd">      value: (str) initial value</span>
<span class="sd">      options: (list of str) value options</span>
<span class="sd">      title: display name</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Select</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">on_change</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_change</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">on_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">new</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">[</span><span class="n">new</span><span class="p">](</span><span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">value</span>

  <span class="nd">@value</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">_value</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">options</span>

  <span class="nd">@options</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">_value</span>


<span class="k">class</span> <span class="nc">StrInput</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Input a str, and run actions on change of value.</span>

<span class="sd">  Attributes:</span>
<span class="sd">    self.widget: a bokeh.models.TextInput containing the value</span>
<span class="sd">    self.update: A list of callables that should be called on changes of the cutoff value.</span>
<span class="sd">      Signature should be f(attrname, old, new), where &#39;old&#39; and &#39;new&#39; are str.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;text here&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Str input:&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments:</span>
<span class="sd">      value: Value to use for cutoff.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">TextInput</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">on_change</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_change</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">on_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
      <span class="n">f</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">value</span>

  <span class="nd">@value</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">_value</span>


<span class="k">class</span> <span class="nc">GUIOptions</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Attributes:</span>
<span class="sd">    self.widget: a bokeh.models.TextInput containing the value</span>
<span class="sd">    self.layout: layout to include in page</span>
<span class="sd">    self.update: A list of callables that should be called on changes of the cutoff value.</span>
<span class="sd">      Signature should be f(attrname, old, new), where &#39;old&#39; and &#39;new&#39; are str.</span>
<span class="sd">    self.session: a casm.plotting.Session</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments:</span>
<span class="sd">      session: the bokeh push_session</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Select</span><span class="p">(</span>
      <span class="n">value</span><span class="o">=</span><span class="s2">&quot;Options&quot;</span><span class="p">,</span>
      <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Options&quot;</span><span class="p">,</span> <span class="s2">&quot;Close (without saving)&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">select_action_f</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">new</span> <span class="o">==</span> <span class="s2">&quot;Close (without saving)&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Session is closed&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;Session is closed&quot;</span>
        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">select_action_f</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">on_change</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_change</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">bk_layouts</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">on_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
      <span class="n">f</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">value</span>

  <span class="nd">@value</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">_value</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, CASM Developers.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.3.dev',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>